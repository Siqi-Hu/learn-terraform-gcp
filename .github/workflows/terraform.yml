name: Terraform CI

on:
  pull_request:
    branches:
      - main   # target branch linked to your HCP Terraform workspace
  # push:
  #   branches:
  #     - main   # optional, re-run validation on main merges

permissions:
  contents: read
  pull-requests: write

jobs:
  terraform:
    name: Terraform Validation & Plan
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Terraform CLI
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5   
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      # 3Ô∏è‚É£ Format check
      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      # 4Ô∏è‚É£ Initialize Terraform
      - name: Terraform Init
        run: terraform init -input=false

      # 5Ô∏è‚É£ Validate syntax and provider configs
      - name: Terraform Validate
        run: terraform validate

      - name: Fetch speculative plan from HCP Terraform and comment on PR
        if: github.event_name == 'pull_request'
        env:
          # TFC_ORG: ${{ vars.TFC_ORG }}
          TFC_WORKSPACE_ID: ${{ vars.TFC_WORKSPACE_ID }}
          TFC_TOKEN: ${{ secrets.TF_API_TOKEN }}
        run: |
          # 1. Get the latest run triggered for this commit
          RUN_ID=$(curl -s \
            --header "Authorization: Bearer $TFC_TOKEN" \
            --header "Content-Type: application/vnd.api+json" \
            "https://app.terraform.io/api/v2/workspaces/${TFC_WORKSPACE_ID}/runs?filter%5Bsource%5D=tfe-configuration-version" \
            | jq -r '.data[0].id')

          echo "Latest speculative run: $RUN_ID"

          # 2. Poll until the run finishes
          STATUS=""
          while true; do
            STATUS=$(curl -s \
              --header "Authorization: Bearer $TFC_TOKEN" \
              "https://app.terraform.io/api/v2/runs/${RUN_ID}" \
              | jq -r '.data.attributes.status')

            echo "Run status: $STATUS"

            if [[ "$STATUS" == "planned" || "$STATUS" == "errored" || "$STATUS" == "planned_and_finished" ]]; then
              break
            fi

            sleep 5
          done

          # 3. Get the plan ID
          PLAN_ID=$(curl -s \
            --header "Authorization: Bearer $TFC_TOKEN" \
            "https://app.terraform.io/api/v2/runs/${RUN_ID}" \
            | jq -r '.data.relationships.plan.data.id')

          echo "Plan ID: $PLAN_ID"

          # 4. Get the log url 
          LOG_URL=$(curl -s \
            --header "Authorization: Bearer $TFC_TOKEN" \
            "https://app.terraform.io/api/v2/plans/${PLAN_ID}" \
            | jq -r '.data.attributes."log-read-url"'' )
          
          echo "Log URL: LOG_URL$"

          # 5. Fetch the actual plan text
          PLAN_TEXT=$(curl -s "$LOG_URL")

          # Fallback if there is an error
          if [ -z "$PLAN_TEXT" ]; then
            PLAN_TEXT="Unable to fetch plan output."
          fi

          # 5. Comment to the Pull Request
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "üß† **Terraform Cloud Speculative Plan:**\n\`\`\`json\n${PLAN_TEXT}\n\`\`\`"